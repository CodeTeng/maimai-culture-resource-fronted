<template>
  <div class="commentListCpn">
    <!-- ÁªÉ‰π† Â∞èÈ°πÁõÆ È¢òÁõÆ -->
    <h1>CommentList</h1>
    <hr />

    <!--  -->
    <div class="commentListCont">
      <!-- ‰∏ÄÁ∫ßËØÑËÆ∫ ËæìÂÖ• -->
      <div class="levelOneCommentInput commentInput">
        <div class="userPhoto">
          <img src="https://c2.im5i.com/2022/09/14/50cQ1.jpg" alt="" />
        </div>
        <div class="input">
          <input
            type="text"
            placeholder="ÊñáÊú¨‰∏≠ÁöÑËØÑËÆ∫Â∞ÜË¢´ÂèëÈÄÅ"
            v-model.lazy.trim="levelOneCommentContent"
          />
          <button @click="handlerlevelOneComment()">ËØÑËÆ∫</button>
        </div>
      </div>

      <!-- ËØÑËÆ∫Ê∏≤Êüì -->
      <div class="commentList">
        <!-- ËØÑËÆ∫item -->
        <div
          class="commentItemCont"
          v-for="item in renderData"
          :key="item.parent.id"
        >
          <!-- ÔºÅÔºÅÔºÅÔºÅ‰∏ÄÁ∫ßËØÑËÆ∫ -->
          <div class="levelOneComment commentItem">
            <!-- Â§¥ÂÉè -->
            <div class="userPhoto">
              <img src="https://c2.im5i.com/2022/09/14/50syn.jpg" alt="" />
            </div>
            <!-- ËØÑËÆ∫ÂÜÖÂÆπ -->
            <div class="userComment">
              <p class="userName">{{ item.parent.nick_name }}</p>
              <p class="content">{{ item.parent.content }}</p>
              <p class="operationBar">
                <span class="commentDate">{{ item.parent.time }}</span>
                <span class="commentBtn" @click="showChild(item.itemId)"
                >ÂõûÂ§ç</span
                >
              </p>
            </div>
          </div>

          <!-- ÔºÅÔºÅÔºÅÔºÅÔºÅ‰∫åÁ∫ßËØÑËÆ∫ -->
          <!-- item.isShowChild -->
          <div
            class="levelTwoComment"
            :class="{ levelTwoCommentShow: item.isShowChild }"
          >
            <div class="levelOneCommentInput commentInput">
              <div class="input">
                <input
                  type="text"
                  placeholder="ÊñáÊú¨‰∏≠ÁöÑËØÑËÆ∫Â∞ÜË¢´ÂèëÈÄÅ"
                  v-model.lazy.trim="levelTwoCommentContent"
                />
                <button @click="handlerlevelTwoComment(item.parent.id)">
                  ËØÑËÆ∫
                </button>
              </div>
            </div>
            <div
              class="commentItem"
              v-for="subitem in item.child"
              :key="subitem.id"
            >
              <div class="userPhoto">
                <!-- https://c2.im5i.com/2022/09/14/50cQ1.jpg
                      https://c2.im5i.com/2022/09/14/50syn.jpg
                 -->
                <img src="https://c2.im5i.com/2022/09/14/50hjy.jpg" alt="" />
              </div>
              <div class="userComment">
                <p class="userName">{{ subitem.nick_name }}</p>
                <p class="content">{{ subitem.content }}</p>
                <p class="operationBar">
                  <span class="commentDate">{{ subitem.time }}</span>
                </p>
              </div>
            </div>
          </div>

          <!-- ÂàÜÂâ≤Á∫ø -->
          <div class="isShowLine"></div>
        </div>
        <div class="endTip">Ê≤°ÊúâÊõ¥Â§öÊï∞ÊçÆ‰∫Ü</div>
      </div>
    </div>
  </div>
</template>

<script setup>
// ÂºïÂÖ•
import { onUpdated, ref, reactive, watch } from 'vue'

// Áî≥Êòé ÂìçÂ∫îÂºèÊï∞ÊçÆ ====================
let originCommentListData = reactive({
  data: [
    {
      id: 1,
      nick_name: 'ÂÜ¨Â§©ÁöÑÈõ®',
      content: 'ÈùûÂ∏∏Â•ΩÁöÑÊñáÁ´†ÔºÅ',
      parent_id: 0,
      time: 1625454585,
      boolChild: false
    },
    {
      id: 2,
      nick_name: 'ÂçäÊ†àjava',
      content: 'Â∫ïÂ±ÇÂÆûÁé∞ÊúâÁÇπÁúãËíôÂúà‰∫Ü„ÄÇjavaÂíåc‰ª£Á†ÅÈÉΩÊúâ„ÄÇcÊòØclassËøòÂ∑Æ‰∏çÂ§öÔºÅ',
      parent_id: 0,
      time: 1625368185,
      boolChild: false
    },
    {
      id: 3,
      nick_name: 'Áî®Êà∑891368888118',
      content: 'Êå∫Â§öÂπ≤Ë¥ßÁöÑÔºÅ',
      parent_id: 0,
      time: 1625364585,
      boolChild: false
    },
    {
      id: 4,
      nick_name: 'ÂàùÁ∫ßÂâçÁ´ØÈÄâÊâã',
      content: 'Êî∂Ëóè‰∫ÜÔºÅÔºÅ',
      parent_id: 0,
      time: 1622772585,
      boolChild: false
    },
    {
      id: 5,
      nick_name: 'Áî®Êà∑2784289850703',
      content: 'ÈùûÂ∏∏Â•ΩÁöÑÊñáÁ´†ÔºÅ',
      parent_id: 0,
      time: 1622754585,
      boolChild: false
    },
    {
      id: 6,
      nick_name: 'Ë∞¢Ë∞¢ÂàÜ‰∫´ÔºÅ',
      content: '‰∏ÄÁõ¥ÁúãÂ§ß‰Ω¨ÁöÑÊñáÁ´†ÔºåÁúü‰∏çÈîôÔºÅ',
      parent_id: 0,
      time: 1623186585,
      boolChild: false
    },
    {
      id: 7,
      nick_name: 'Áúü‰∏çÈîôÔºÅ',
      content: '‰ºòÁßÄÂëÄÔºÅ',
      parent_id: 0,
      time: 1623222585,
      boolChild: false
    },
    {
      id: 8,
      nick_name: 'ÂèàÂÇªÂèàÁ¨®ÁöÑ‰∫åÁãó',
      content: 'Âä†Ê≤πÔºåÂä†Ê≤πÔºÅ',
      parent_id: 5,
      time: 1623225345,
      boolChild: false
    },
    {
      id: 9,
      nick_name: 'Êò®Â§©‰∏çÂÜçÊòØÊò®Â§©',
      content: 'Â∏åÊúõÂ§ß‰Ω¨Â§öÂàÜ‰∫´ÊñáÁ´†ÔºÅ ',
      parent_id: 5,
      time: 1625039745,
      boolChild: false
    },
    {
      id: 10,
      nick_name: 'Áî®Êà∑8128696273319',
      content: 'ÊØîËæÉËØ¶ÁªÜÔºåË∞¢Ë∞¢ÔºÅ',
      parent_id: 5,
      time: 1624002945,
      boolChild: false
    },
    {
      id: 11,
      nick_name: 'Áî®Êà∑458666108980',
      content: 'Â§™Âº∫‰∫ÜÔºÅ',
      parent_id: 5,
      time: 1625454701,
      boolChild: false
    },
    {
      id: 12,
      nick_name: 'Áî®Êà∑3009977972039',
      content: 'ÊÑüË∞¢ÂàÜ‰∫´ÔºÅ',
      parent_id: 5,
      time: 1625454705,
      boolChild: false
    },
    {
      id: 13,
      nick_name: 'Áî®Êà∑1734135186928',
      content: 'ÊñáÁ´†‰∏çÈîôÔºÅ',
      parent_id: 0,
      time: 1625454708,
      boolChild: false
    },
    {
      id: 14,
      nick_name: 'Áî®Êà∑8547655399924',
      content: 'nice',
      parent_id: 0,
      time: 1625454696,
      boolChild: false
    },
    {
      id: 15,
      nick_name: 'Áî®Êà∑2450039971636',
      content: 'Ëøò‰∏çÈîô',
      parent_id: 1,
      time: 1625195496,
      boolChild: false
    },
    {
      id: 16,
      nick_name: 'Áî®Êà∑9527',
      content: 'Êî∂ËóèÈ•ø‰∫Ü',
      parent_id: 1,
      time: 1625454733,
      boolChild: false
    },
    {
      id: 17,
      nick_name: 'SAM9029',
      content: 'üêºüê∏ü¶ìüê¥',
      parent_id: 0,
      time: 1625454733,
      boolChild: false
    }
  ]
})

// Êï¥ÂêàÊï∞ÊçÆ
let renderData = ref()

// ÁõëÂê¨ Âπ∂ÂàõÂª∫ Êñ∞ÁöÑÊ∏≤ÊüìËØÑËÆ∫ÂàóË°® Êï∞ÊçÆ
watch(() => originCommentListData.data, updateCommentData, {
  deep: true,
  immediate: true
})

// Êõ¥Êñ∞Êï¥ÂêàÂáΩÊï∞Êï∞ÊçÆ
function updateCommentData() {
  // Ê∑±Êã∑Ë¥ù Ê∂àÈô§ ÂΩ±ÂìçÊ∫êÊï∞ÊçÆ
  let deepCloneOriginData = JSON.parse(
    JSON.stringify(originCommentListData.data)
  )

  // Á≠õÂá∫ ‰∏ÄÁ∫ßËØÑËÆ∫
  let parentData = deepCloneOriginData.filter((item) => item.parent_id === 0)

  // Á≠õÂá∫ ‰∫åÁ∫ßËØÑËÆ∫
  let childData = deepCloneOriginData.filter((item) => item.parent_id !== 0)

  // Êó∂Èó¥ ÂÄíÂ∫èÊéíÂ∫èÂ§ÑÁêÜ
  parentData.sort((a, b) => b.time - a.time)
  childData.sort((a, b) => b.time - a.time)

  // Êó∂Èó¥ÊØ´ÁßíËΩ¨Êç¢Â§ÑÁêÜ
  parentData.map((item) => {
    item.time = timeToggle(item.time)
  })
  childData.map((item) => {
    item.time = timeToggle(item.time)
  })

  let newRenderData = []

  for (let i = 0; i < parentData.length; i++) {
    newRenderData.push({
      itemId: parentData[i].id,
      parent: { ...parentData[i] },
      child: JSON.parse(
        JSON.stringify(
          childData.filter((item) => item.parent_id === parentData[i].id)
        )
      ),
      isShowChild: false
    })
  }
  renderData.value = JSON.parse(JSON.stringify(newRenderData))

  console.log(JSON.parse(JSON.stringify(renderData.value)))
  // ËøîÂõûÁ≠õÂá∫Êï∞ÊçÆ
  return newRenderData
}

// Â±ïÂºÄ ‰∫åÁ∫ßÊéßÂà∂
function showChild(_id) {
  renderData.value.map((item) => {
    if (item.itemId === _id) {
      // console.log(item.isShowChild)
      item.isShowChild = !item.isShowChild
      // console.log(item.isShowChild)
    }
  })
}

// ‰∏ÄÁ∫ßËØÑËÆ∫ÂÜÖÂÆπ
let levelOneCommentContent = ref()
// ‰∫åÁ∫ßËØÑËÆ∫ÂÜÖÂÆπ
let levelTwoCommentContent = ref()

function handlerlevelOneComment() {
  if (levelOneCommentContent.value) {
    // Êó∂Èó¥Â§ÑÁêÜ
    let nowTime = new Date().getTime()

    // Â¢ûÂä† ËØÑËÆ∫
    originCommentListData.data.push({
      id: originCommentListData.data.length + 1,
      nick_name: 'SAM9029',
      content: levelOneCommentContent.value,
      parent_id: 0,
      time: nowTime,
      boolChild: false
    })

    levelOneCommentContent.value = ''
    alert('ËØÑËÆ∫ÊàêÂäüÔºÅ')
  } else {
    alert('ËØ∑ÂãøËæìÂÖ•Á©∫ÂÄºÔºÅ')
  }
}
let levelTwoReControlId = ref()
function handlerlevelTwoComment(_parentId) {
  if (levelTwoCommentContent.value) {
    // Êó∂Èó¥Â§ÑÁêÜ
    let nowTime = new Date().getTime()

    // Â¢ûÂä† ËØÑËÆ∫
    originCommentListData.data.push({
      id: originCommentListData.data.length + 1,
      nick_name: 'SAM9029',
      content: levelTwoCommentContent.value,
      parent_id: _parentId,
      time: nowTime,
      boolChild: false
    })

    levelTwoReControlId.value = _parentId
    levelTwoCommentContent.value = ''
    alert('ËØÑËÆ∫ÊàêÂäüÔºÅ')
  } else {
    alert('ËØ∑ÂãøËæìÂÖ•Á©∫ÂÄºÔºÅ')
  }
}

// ‰∫åÁ∫ßËØÑËÆ∫Êñ∞Â¢ûÊó∂ÔºåÂÜçÊ¨°Ê∏≤ÊüìË¶ÅÈáçÊñ∞ÂØπÂ∫îÁöÑ‰∫åÁ∫ßËØÑËÆ∫Â±ïÂºÄ
onUpdated(() => {
  console.log('updateCommentData')

  for (let i = 0, len = renderData.value.length; i < len; i++) {
    if (renderData.value[i].itemId === levelTwoReControlId.value) {
      renderData.value[i].isShowChild = true
      levelTwoReControlId.value = ''
      // ËäÇÁ∫¶ÊÄßËÉΩ
      return
    }
  }
})

// Êó∂Èó¥Êà≥ ËΩ¨Êç¢ Â§ÑÁêÜ
function timeToggle(_time) {
  let commentDate = new Date(_time)
  let year = commentDate.getFullYear()
  let month = commentDate.getMonth() + 1
  let date = commentDate.getDate()
  let commentClock = commentDate.toString().split(' ')[4]

  return `${year}/${month}/${date} ${commentClock}`
}
</script>

<style>
.commentListCpn {
  padding: 5px;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
}

h1 {
  font-size: 25px;
  font-weight: bolder;
}

hr {
  border-top: 1px solid #eee;
  width: 100%;
}

.commentListCont {
  /*border: 1px solid #eee;*/
  margin: 10px auto;
  width: 80%;
  /*temp height*/
  /*height: 600px;*/

  min-width: 650px;
  box-shadow: 1px 1px 5px 5px #999;

  flex: 1;

  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

/* Â§¥ÂÉè */
.userPhoto {
  width: 50px;
  height: 50px;
  border-radius: 50px;
  overflow: hidden;
  margin-right: 15px;
}

.userPhoto img {
  width: 100%;
  height: 100%;
}

/*‰∏ÄÁ∫ß,‰∫åÁ∫ß,ËØÑËÆ∫ËæìÂÖ•*/
.commentInput {
  width: 100%;
  padding: 15px;
  background-color: #dedfe0;
  height: 60px;
  display: flex;
  /*justify-content: ;*/
  align-items: center;
}

.commentInput .input {
  flex: 1;
  position: relative;
}

.commentInput .input > input {
  width: 100%;
  display: block;
  box-sizing: border-box;
  height: 30px;
  border: 1px solid black;
  border-right: none;
  border-radius: 20px;
  outline: none;
  padding: 0 30px 0 10px;
  color: #666;
}

.commentInput .input > button {
  position: absolute;
  right: 0;
  top: 0;
  border-radius: 20px;
  height: 30px;
  padding: 0 15px;
  border: none;
  box-sizing: border-box;
  box-shadow: 1px 1px 5px 5px #999;
}

.commentInput .input > button:active {
  box-shadow: 1px 1px 5px 5px #999 inset;
}

/* ËØÑËÆ∫ÂàóË°® */
.commentList {
  flex: 1;
  width: 100%;
  padding: 0 5px;
  overflow: auto;
}

/*‰∏ÄÁ∫ßËØÑËÆ∫*/
.levelOneComment {
  /*border: 1px solid tomato; */
}

/*‰∫åÁ∫ßËØÑËÆ∫*/
.levelTwoComment {
  display: none;
  /*border: 1px solid skyblue; */
  padding: 0 0 0 80px;
}

/*‰∫åÁ∫ßËØÑËÆ∫Â±ïÁ§∫ÊéßÂà∂*/
.levelTwoCommentShow {
  display: block;
}

/*ËØÑËÆ∫item*/
.commentItem {
  width: 100%;
  height: 100px;
  padding: 10px 15px;
  color: #666 !important;

  display: flex;
  justify-content: space-between;
}

.isShowLine {
  border-bottom: 1px solid #aaa;
}

.commentItem .userComment {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.commentItem .userComment .userName {
  font-weight: bolder;
}

.commentItem .userComment .content {
  flex: 1;
  display: flex;
  align-items: center;
}

.commentItem .userComment .operationBar {
  display: inline-flex;
  justify-content: space-between;
  color: #999;
}
</style>
